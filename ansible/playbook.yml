---
- name: Configure web servers with NGINX
  hosts: webservers
  gather_facts: yes
  become: yes

  vars:
    nginx_port: 80
    server_name: localhost

  tasks:
    - name: Display instance information
      debug:
        msg: "Configuring instance {{ instance_id | default('unknown') }}"

    - name: Update apt cache (Debian/Ubuntu)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      ignore_errors: yes

    - name: Install NGINX
      package:
        name: nginx
        state: present
      ignore_errors: yes
      register: nginx_install

    - name: Check if NGINX is already running
      shell: pgrep nginx || echo "not_running"
      register: nginx_status
      changed_when: false
      failed_when: false

    - name: Create custom index.html
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>IaC Demo - Success!</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  .container {
                      background: rgba(255, 255, 255, 0.1);
                      padding: 40px;
                      border-radius: 10px;
                      backdrop-filter: blur(10px);
                  }
                  h1 { margin-top: 0; }
                  .info { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px; margin: 20px 0; }
                  .success { color: #4ade80; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸš€ Infrastructure as Code Demo</h1>
                  <p class="success">âœ… Deployment Successful!</p>
                  <div class="info">
                      <h3>Stack Components:</h3>
                      <ul>
                          <li><strong>Infrastructure:</strong> Terraform</li>
                          <li><strong>Configuration:</strong> Ansible</li>
                          <li><strong>Simulation:</strong> Localstack</li>
                          <li><strong>Web Server:</strong> NGINX</li>
                      </ul>
                  </div>
                  <p>This page was deployed using a fully automated IaC pipeline that provisions infrastructure with Terraform and configures it with Ansible.</p>
                  <p><em>Instance ID: {{ instance_id | default('simulated') }}</em></p>
              </div>
          </body>
          </html>
        dest: /tmp/index.html
        mode: '0644'
      ignore_errors: yes

    - name: Copy custom index to NGINX directory
      copy:
        src: /tmp/index.html
        dest: /usr/share/nginx/html/index.html
        remote_src: yes
        mode: '0644'
      ignore_errors: yes
      when: nginx_install is succeeded

    - name: Start NGINX service
      service:
        name: nginx
        state: started
        enabled: yes
      ignore_errors: yes
      when: nginx_install is succeeded

    - name: Verify NGINX is responding
      uri:
        url: "http://localhost:{{ nginx_port }}"
        status_code: 200
        timeout: 5
      register: nginx_response
      ignore_errors: yes
      when: nginx_install is succeeded

    - name: Display verification result
      debug:
        msg: "NGINX is {{ 'running and responding' if (nginx_response is succeeded) else 'installed (verification skipped in Localstack mode)' }}"

    - name: Create deployment summary
      debug:
        msg:
          - "=========================================="
          - "Deployment Summary"
          - "=========================================="
          - "Instance ID: {{ instance_id | default('simulated') }}"
          - "NGINX Status: {{ 'Running' if (nginx_status.stdout.find('not_running') == -1) else 'Installed' }}"
          - "Web Server: http://localhost:{{ nginx_port }}"
          - "=========================================="
